# Kleio-server token setup

MHK needs a token to access the Kleio server
with privileges to create tokens. This is
called an administration token.

The token but be shared between the MHK web app
and the Kleio Server running in a different container.



## Getting an admin token

The MHK web app tries to locate the 
the administrator token in the following
order.

1. from environment variable KLEIO_ADMIN_TOKEN
2. from the file `mhk-home/system/conf/mhk.kleio.service.token.admin`
3. from the servlet context attribute `mhk.kleio.service.token.admin`. The context attributes
can be setup in the file `mhk-home/system/conf/mhk_system.properties`
4. from `mhk-home/system/conf/kleio/.bootstrap_token`. This is a short lived
token generated by the kleio service on startup. MHK will use
this token to generate a long lived token and store it in the file `mhk-home/system/conf/mhk.kleio.service.token.admin` where
it can be subsequently fetched by
number 2).

## Technical note

Securing a Kleio Server token is done in

```java
CentralServlet.getServiceAdminToken(ServletContext context)
````

In normal operation the Kleio Server and the MHK web app
are started at the same time. 

The most probable pattern in a new instalation is that
option 4. is used in the first run and subsequently option 2.

If comunication with Kleio is not occurring (error information
when trying to access the "sources" separator) it is because
MHK is trying to use a token that is unkown to the Kleio Server.

In that case do:

1.delete `mhk-home/system/conf/mhk.kleio.service.token.admin`
2. remove or comment out the line with `mhk.kleio.service.token.admin` in
   the file `mhk-home/system/conf/mhk_system.properties` 
3. delete file `mhk-home/system/conf/kleio/.bootstrap_token`
4. Restart MHK with `mhk stop; mhk start`






